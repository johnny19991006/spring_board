<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud2.js" defer></script>
    <title>오늘의 주가</title>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card-header {
            background-color: #007bff;
            color: white;
        }
        .card {
            margin-bottom: 20px;
        }
        .progress {
            height: 30px;
        }
        .progress-bar {
            font-size: 1rem;
        }
        .text-center {
            margin-top: 10px;
        }
        h4, h5 {
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .keyword-list {
            columns: 2;
            -webkit-columns: 2;
            -moz-columns: 2;
        }
        .alert {
            margin-top: 20px;
        }
        #negativeWordCloud, #neutralWordCloud, #positiveWordCloud, #newsWordCloud, #totalWordCloud {
            width: 100%;
            height: 400px;
            position: relative;
        }
    </style>
</head>
<body>
<div class="container">
    <div th:replace="nav.html :: fragment-nav"></div>

    <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}"></div>

    <div class="h4 pb-2 mb-4 text-danger border-bottom border-info"></div>
    <div><span>조회시간: </span><span th:text="${jobDate}"></span></div>

    <div th:if="${equity != null}" class="card">
        <div class="card-header">
            <h2 th:text="${stockName} ?: 'Unknown Stock'">Stock Information</h2>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <span class="fs-1" th:text="${equity.stck_prpr} + '원'">Price</span>
                <div>
                    <span th:text="${equity.prdy_vrss} + '원'" th:style="${equity.prdy_vrss_sign < '3' ? 'color:red' : (equity.prdy_vrss_sign > '3' ? 'color:blue' : 'color:black')}">Change</span>
                    <span th:text="${equity.prdy_ctrt} + '%'" th:style="${equity.prdy_vrss_sign < '3' ? 'color:red' : (equity.prdy_vrss_sign > '3' ? 'color:blue' : 'color:black')}">Rate</span>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${equity == null}" class="alert alert-info" role="alert">
        No data available for the specified stock.
    </div>

    <div th:if="${equity != null}" class="card">
        <div class="card-body">
            <table class="table">
                <tbody>
                <tr>
                    <td>PER</td>
                    <td th:text="${equity.per}">N/A</td>
                    <td>EPS</td>
                    <td th:text="${equity.eps}">N/A</td>
                </tr>
                <tr>
                    <td>PBR</td>
                    <td th:text="${equity.pbr}">N/A</td>
                    <td>BPS</td>
                    <td th:text="${equity.bps}">N/A</td>
                </tr>
                </tbody>
            </table>
            <div class="p-3 mt-3 bg-light border">
                <h4 class="text-center">댓글 긍부정 판단</h4>
                <p class="text-center" th:text="${sentimentTotalSentiment}">Sentiment</p>
                <div class="progress">
                    <div class="progress-bar" role="progressbar"
                         th:classappend="${sentimentTotalSentiment == 'negative' ? 'bg-danger' : (sentimentTotalSentiment == 'positive' ? 'bg-success' : 'bg-secondary')}"
                         th:style="'width:' + ${sentimentTotalScore} + '%;'"
                         th:text="${sentimentTotalScore} + '/100 points'">0/100 points</div>
                </div>

                <div class="text-center mt-4">
                    <h5>네이버토론방</h5>
                    <div th:if="${sentimentPositive != null}">
                        <p>긍정 의견: <span th:text="${sentimentPositive.comments != null ? sentimentPositive.comments : 0}">0</span></p>
                    </div>
                    <div th:if="${sentimentNeutral != null}">
                        <p>중립 의견: <span th:text="${sentimentNeutral.comments != null ? sentimentNeutral.comments : 0}">0</span></p>
                    </div>
                    <div th:if="${sentimentNegative != null}">
                        <p>부정 의견: <span th:text="${sentimentNegative.comments != null ? sentimentNegative.comments : 0}">0</span></p>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <h5>Investing</h5>
                    <div th:if="${sentimentPositive != null}">
                        <p>긍정 투자 의견: <span th:text="${sentimentPositive.investing != null ? sentimentPositive.investing : 0}">0</span></p>
                    </div>
                    <div th:if="${sentimentNeutral != null}">
                        <p>중립 투자 의견: <span th:text="${sentimentNeutral.investing != null ? sentimentNeutral.investing : 0}">0</span></p>
                    </div>
                    <div th:if="${sentimentNegative != null}">
                        <p>부정 투자 의견: <span th:text="${sentimentNegative.investing != null ? sentimentNegative.investing : 0}">0</span></p>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <h5>뉴스</h5>
                    <div th:if="${sentimentPositive != null}">
                        <p>긍정 뉴스: <span th:text="${sentimentPositive.news != null ? sentimentPositive.news : 0}">0</span></p>
                    </div>
                    <div th:if="${sentimentNeutral != null}">
                        <p>중립 뉴스: <span th:text="${sentimentNeutral.news != null ? sentimentNeutral.news : 0}">0</span></p>
                    </div>
                    <div th:if="${sentimentNegative != null}">
                        <p>부정 뉴스: <span th:text="${sentimentNegative.news != null ? sentimentNegative.news : 0}">0</span></p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div th:if="${equity != null}" class="card">
        <div class="card-body">
            <h4 class="text-center">키워드 분석</h4>
            <div class="row">
                <div class="col-md-4" th:if="${keywords != null and keywords.negative != null}">
                    <h5 class="text-danger">부정</h5>
                    <div id="negativeWordCloud"></div>
                </div>
                <div class="col-md-4" th:if="${keywords != null and keywords.neutral != null}">
                    <h5 class="text-secondary">중립</h5>
                    <div id="neutralWordCloud"></div>
                </div>
                <div class="col-md-4" th:if="${keywords != null and keywords.positive != null}">
                    <h5 class="text-success">긍정</h5>
                    <div id="positiveWordCloud"></div>
                </div>
            </div>
            <div class="mt-4" th:if="${keywords != null and keywords.news != null}">
                <h5 class="text-primary">뉴스 키워드</h5>
                <div id="newsWordCloud"></div>
            </div>
            <div class="mt-4" th:if="${keywords != null and keywords.total != null}">
                <h5 class="text-primary">전체 키워드</h5>
                <div id="totalWordCloud"></div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const keywords = /*[[${keywords}]]*/ {};

        const createWordCloud = (elementId, keywordList, color) => {
            const list = keywordList.map(keyword => [keyword, Math.random() * 100]);
            WordCloud(document.getElementById(elementId), {
                list: list,
                color: color,
                backgroundColor: '#f8f9fa',
            });
        };

        if (keywords.negative) {
            createWordCloud('negativeWordCloud', keywords.negative, '#dc3545');
        }

        if (keywords.neutral) {
            createWordCloud('neutralWordCloud', keywords.neutral, '#6c757d');
        }

        if (keywords.positive) {
            createWordCloud('positiveWordCloud', keywords.positive, '#28a745');
        }

        if (keywords.news) {
            createWordCloud('newsWordCloud', keywords.news, '#007bff');
        }

        if (keywords.total) {
            createWordCloud('totalWordCloud', keywords.total, '#17a2b8');
        }
    });
</script>
</body>
</html>
